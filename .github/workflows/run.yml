name: form-example

on:
 workflow_dispatch:
  inputs:
   input_node:
    description: 'Input Node Name.'
    required: true
env:
 complist: '[]'
    
jobs:
  excelgraph:
    env:
      #input_compo: "Tlmf"
      input_compo: '["Tlmf","Lcd","Bsm","DestJdg","OmiArb"]'
    runs-on: windows-latest
    outputs:
      compo_list:  ${{ steps.create_unittest_brach.outputs.compo_list }}
      compo_testtype:  ${{ steps.create_unittest_brach.outputs.compo_testtype }}
      targetcompolist:  ${{ steps.create_unittest_brach.outputs.targetcompolist }}
    steps:
    - uses: actions/checkout@v3
    - name: Create UnitTest Branch
      id: create_unittest_brach
      run: |
       $targetcompo='["Bsm"]'
       $compo_list = $targetcompo

       echo "compo_list=$compo_list" | Out-File -Append -FilePath $env:GITHUB_OUTPUT

    - name: run test
      run: |
       $JsonFilePath = ".github/workflows/choices.json"
       $JsonData = Get-Content $JsonFilePath -Raw | ConvertFrom-Json
       foreach ($compo in ${{ fromJson(steps.create_unittest_brach.outputs.compo_list) }} | ConvertFrom-Json ) {
         echo "compo=$compo"
         foreach ($comp_info in $JsonData.PSObject.Properties.Value) {
           $testtype = $comp_info.test_type
         }
         echo "testtype=$testtype"
         # 取得したテスト種別がcsv(csvのみ実施)・gtest(gtestのみ実施)・mix(csvとgtestを実施)に該当しない場合、エラーとする
         if ($testtype -eq 'csv' -or $testtype -eq 'gtest' -or $testtype -eq 'mix') {
           # コンポを格納
           $compolist += "`""
           $compolist += $node_name
           $compolist += "`""
           $compolist += ","
           echo "complist+=('$node_name')"  | Out-File -Append -FilePath $env:GITHUB_ENV
         } else {
           $error_comment="【ERROR】There is an error in the test type : $testtype : compo : $compo ."
           echo "::error::$error_comment"
         }
       }
       $compolist += "]"
       $compolist = $compolist -replace '\,]',']'

       echo "complist=$compolist"
       #echo "complist=$complist" | Out-File -Append -FilePath $env:GITHUB_ENV


  Exec_GTestConvTool:
    runs-on: windows-latest
    needs: excelgraph
    strategy:
      max-parallel: 5
      matrix:
        compolist: ${{fromJson(needs.excelgraph.outputs.compo_list)}}
    steps:
    - uses: actions/checkout@v3
    - name: check
      run: |
        pwd
        dir
        cd ./.github
        dir
        cd ./workflows
        dir
        echo "compolist=${{env.complist}}"

  Exec_ECU-Build:
    runs-on: windows-latest
    needs: [excelgraph,Exec_GTestConvTool]
    strategy:
      max-parallel: 2
      matrix:
        compolist: ${{fromJson(needs.excelgraph.outputs.compo_list)}}
    if: always()
    steps:
      - name: Clean self-hosted runner
        run: |
          echo "Exec_ECU-Build"
          echo ${{ matrix.compolist }}
